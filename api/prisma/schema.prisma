// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Médicos del sistema
model Medico {
  id             Int              @id @default(autoincrement())
  nombre         String
  email          String           @unique
  activo         Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  user           User?            @relation(fields: [userId], references: [id])
  userId         Int?             @unique
  asignaciones   Asignacion[]
  disponibilidad Disponibilidad[]
}

// Períodos de feriados (Semana Santa, Navidad, etc.)
// Cada período Dk tiene varios días contiguos de feriado
model Periodo {
  id           Int          @id @default(autoincrement())
  nombre       String // "Semana Santa 2026", "Navidad 2026"
  fechaInicio  DateTime
  fechaFin     DateTime
  createdAt    DateTime     @default(now())
  feriados     Feriado[] // Días que componen este período
  asignaciones Asignacion[] // Asignaciones generadas
}

// Usuarios del sistema (autenticación)
model User {
  id        Int      @id @default(autoincrement())
  nombre    String
  email     String   @unique
  password  String // Hash de contraseña
  rol       String // ADMIN, MEDICO, LECTOR
  medico    Medico?
  createdAt DateTime @default(now())
}

// Días feriados individuales (pertenecen a un período)
model Feriado {
  id          Int      @id @default(autoincrement())
  fecha       DateTime @unique
  descripcion String
  periodo     Periodo  @relation(fields: [periodoId], references: [id])
  periodoId   Int

  @@index([periodoId])
}

// Disponibilidad: días en que cada médico puede trabajar (Si)
model Disponibilidad {
  id       Int      @id @default(autoincrement())
  medico   Medico   @relation(fields: [medicoId], references: [id])
  medicoId Int
  fecha    DateTime // Día disponible

  @@unique([medicoId, fecha]) // Un médico no puede tener duplicados
  @@index([medicoId])
  @@index([fecha])
}

// Configuración global del sistema
model Configuracion {
  id                    Int @id @default(autoincrement())
  maxGuardiasTotales    Int @default(3) // C: máximo días asignados por médico en total
  maxGuardiasPorPeriodo Int @default(1) // Máximo días asignados por médico dentro de un mismo período
  medicosPorDia         Int @default(1) // Cuántos médicos se necesitan por día
}

// Asignaciones generadas por el solver
model Asignacion {
  id        Int      @id @default(autoincrement())
  fecha     DateTime
  medico    Medico   @relation(fields: [medicoId], references: [id])
  medicoId  Int
  periodo   Periodo  @relation(fields: [periodoId], references: [id])
  periodoId Int
  createdAt DateTime @default(now())

  @@unique([fecha, medicoId]) // Un médico no puede tener dos asignaciones el mismo día
  @@index([medicoId])
  @@index([periodoId])
}

// Registro de auditoría de acciones críticas
model AuditLog {
  id        Int      @id @default(autoincrement())
  accion    String // Ej: "RESOLVER", "REPARAR", "CONFIG_UPDATE"
  usuario   String // Email del usuario (admin)
  detalles  String? // JSON string con detalles
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([usuario])
}
